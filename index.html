<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>A Bayesian t-test: Bayes factors as a special case of estimation</title>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,400italic,700,700italic' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="css/squaregrid.css" />
  <style type="text/css">
  .legendLabel {
    font-size: 11px;
    line-height: 0px;
  }
  
  .item_title,
  .item_description {
    font-size: 14px;
    line-height: 125%;
    text-align: center;
    padding-top: 5px;
  }
  
  .page_bottom {
    font-size: 14px;
    line-height: 125%;
    text-align: center;
    color: gray;
  }
  
  body {
    font-family: 'Open Sans', sans-serif;
    background-color: #ffffff;
    font-size: 15px;
    line-height: 18px;
  }
  </style>
  <!--<script type="text/javascript" src="js/jquery-1.4.4.min.js"></script> -->
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
  <!--<script type="text/javascript" src="js/jquery-ui-1.8.9.min.js"></script>-->
  <script type="text/javascript" src="js/jquery.flot.min.js"></script>
  <script type="text/javascript" src="js/jstat.js"></script>
  <script type="text/javascript" src="js/mcmc.js"></script>
  <script type="text/javascript" src="js/distributions.js"></script>
  <script type="text/javascript" src="js/bayes_null_ttest.js"></script>
  <script type="text/javascript">
  var burn_timeout_id
  var sample_timeout_id
  var plot_timeout_id
  var running_asynch = false;
  var chain;
  var eff_size_xlim = [-3.5, 3.5];
  

  $(document).ready(function() {
    update_null_prior_label();
    update_rope_label();
    $("#animated_plots_div").hide();
    $("#more_results_wrapper_div").hide();
  });

  function write_log(s) {
    if($("#log").length) {
      $("#log").val($("#log").val() + s)
      $("#log").scrollTop($("#log")[0].scrollHeight);
    }
  }

  function run_model() {
    write_log("\n")
    window.clearTimeout(burn_timeout_id)
    window.clearTimeout(sample_timeout_id)
    window.clearTimeout(plot_timeout_id)
    $("#start_button").html('Click to restart!');

    var y1 = string_to_num_array($("#data_group_1").val())
    var y2 = string_to_num_array($("#data_group_2").val())

    try {
      jStat.map(y1.concat(y2), function(x) {
        if (x - 0 != x) throw "ERROR"
      })
    } catch (err) {
      write_log("ERROR: Data not supplied for both groups or not formatted correctly.\n")
      return
    }

    var n_samples = parseInt($("#nbr_of_samples_input").val()) + 10
    var n_burnin = parseInt($("#nbr_of_burnin_input").val())


    if (n_samples < 1 || n_burnin < 1 || n_samples - 0 != n_samples || n_burnin - 0 != n_burnin) {
      write_log("ERROR: Nbr of burn-in samples and nbr of regular samples should be > 1, right?\n")
      return
    }

    var prior_scale = parseFloat($("#prior_scale_input").val())
    var null_prior = parseFloat($("#null_prior_input").val())
    var lower_rope = parseFloat(document.getElementById('lower_rope_input').value);
    var upper_rope = parseFloat(document.getElementById('upper_rope_input').value);
    var sampler = new_sampler({ y1: y1, y2: y2 }, null_prior, prior_scale, lower_rope, upper_rope)

    function burn_asynch(n, nbr_of_samples) {
      sampler.burn(nbr_of_samples)
      write_log("*")
      if (n > 0) {
        burn_timeout_id = setTimeout(function() {
          burn_asynch(n - 1)
        }, 0)
      } else {
        if (!isFinite(sampler.log_post())) {
          write_log(
            "Warning: At the end of the burn-in phase the log-posterior was " +
            sampler.log_post() + 
            " which is probably due to floating point errors in the javascript code." + 
            " Try a longer burn-in phase.")
        }
        write_log("\n-- Finished Burn in phase --\n")
        write_log("\n-- Started sampling phase --\n")
        $("#animated_plots_div").show();
        chain = sampler.sample(50)
        sample_timeout_id = n_samples_asynch(n_samples, 50)
        plot_asynch()
      }
    }

    function n_samples_asynch(n, nbr_of_samples) {
      if (n > 0) {
        running_asynch = true
        var samples = sampler.sample(nbr_of_samples)
        
        
        chain = concat_samples(chain, samples);
        return setTimeout(function() {
          n_samples_asynch(n - nbr_of_samples, nbr_of_samples)
        }, 0)
      } else {
        running_asynch = false
        window.clearTimeout(plot_timeout_id)
        write_log("\n -- Finished sampling phase --\n ")
        write_log("-- Results plotted below --\n ")
        
        show_result()
      }
    }


    function plot_asynch() {
      var plot_start_time = new Date()
      var plot_data = chain_to_plot_data(chain, Math.ceil(n_samples / 1000))

      plot_mcmc_chain("eff_size_traceplot", plot_data.eff_size, "samples")

      var lower_rope = parseFloat(document.getElementById('lower_rope_input').value);
      var upper_rope = parseFloat(document.getElementById('upper_rope_input').value);
      

      var xlim = eff_size_xlim;
      var bin_width = 0.2;
      var samples_within_xlim = chain.eff_size.reduce(function(count, s) {
        return count + (s >= xlim[0] && s <= xlim[1]);
      }, 0);
      if(samples_within_xlim / chain.eff_size.length < 0.95) {
        xlim = null;
        bin_width = null;
      }
      

      plot_mcmc_hist("eff_size_hist", chain.eff_size, true, null, true, [lower_rope, upper_rope], xlim, bin_width);

      var plot_time = (new Date()) - plot_start_time
      if (running_asynch) {
        plot_timeout_id = setTimeout(function() {
          plot_asynch()
        }, plot_time * 2)
      }
    }

    function show_result() {
      $("#more_results_wrapper_div").show();
      plot_prob_cat("regions_barplot", chain.region, [-1, 0, 1], ["Low", "Eq.", "High"]);
      plot_prob_cat("model_prob_barplot", chain.is_alt, [0, 1], ["H0", "H1"]);
      var h1_prob = (jStat.sum(chain.is_alt) + 1) / (chain.is_alt.length + 2)
      var bf_for_h1 = h1_prob / (1 - h1_prob)
      $("#bf_span").html((Math.round(h1_prob * 100) / 100) +
                                     " / " + 
                        (Math.round((1 - h1_prob) * 100) / 100) +
                                     " = " + 
                        (Math.round(bf_for_h1 * 100) / 100) )

      var plot_data = chain_to_plot_data(chain, Math.ceil(n_samples / 1000))


      
      // Todo: Not fixed below
      mean_chains = chain.mu.concat(chain.mu2)
      mean_xlim = [jStat.min(mean_chains), jStat.max(mean_chains)]

      plot_mcmc_chain("group1_mean_plot", plot_data.mu, "samples")
      plot_mcmc_chain("group2_mean_plot", plot_data.mu2, "samples")
      plot_mcmc_chain("mean_diff_plot", plot_data.mu_diff, "samples")
      plot_mcmc_chain("sd_plot", plot_data.sigma, "samples")

      plot_mcmc_hist("group1_mean_hist", chain.mu, true, null, true, null, mean_xlim)
      plot_mcmc_hist("group2_mean_hist", chain.mu2, true, null, true, null, mean_xlim)
      plot_mcmc_hist("mean_diff_hist", chain.mu_diff, true, null, true, null)
      plot_mcmc_hist("sd_hist", chain.sigma, true, null, true, null);

      return;

      plot_mcmc_hist("group_diff_hist", param_chain(chain, 5), true, 0)
      plot_mcmc_hist("group1_mean_hist", param_chain(chain, 0), true, null, mean_xlim)
      plot_mcmc_hist("group1_sd_hist", param_chain(chain, 2), true, null, sd_xlim)
      plot_mcmc_hist("group2_mean_hist", param_chain(chain, 1), true, null, mean_xlim)
      plot_mcmc_hist("group2_sd_hist", param_chain(chain, 3), true, null, sd_xlim)
      plot_mcmc_hist("sd_diff_hist", param_chain(chain, 6), true, 0)
      plot_mcmc_hist("normality_hist", param_chain(chain, 7), true)
      plot_mcmc_hist("effect_size_hist", param_chain(chain, 8), true, 0)

    }

    write_log("-- Started Burn in phase --\n")
    burn_asynch(Math.ceil(n_burnin / 500), 500)
  }
  </script>
</head>

<body>
  <div id="wrapper">
    <!-- you need both the wrapper and container -->
    <div id="container">
      <div id="title_div" class="sg-35" style="margin: 0 14px 0px">
        <h1>A Bayesian t-test: Bayes factors as a special case of estimation</h1>
      </div>
      <div id="data_and_instruction_div" class="sg-35 sgParent">
        <div id="data_wrapper_div" class="sg-8 borderRight">
          <br/>
          <!-- Random data, replace with something more interesting. -->
          <div class="item_title">Data - Group 1</div>
          <textarea id="data_group_1" style="width: 100%; height: 100px; box-sizing: border-box; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; ">
            1.9, 0.8, 1.1, 0.1, -0.1, 4.4, 5.5, 1.6, 4.6, 3.4
          </textarea>
          <!-- Random data, replace with something more interesting. -->
          <div class="item_title">Data - Group 2</div>
          <textarea id="data_group_2" style="width: 100%; height: 100px; box-sizing: border-box; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; ">
            0.7, -1.6, -0.2, -1.2, -0.1, 3.4, 3.7, 0.8, 0, 2
          </textarea>
        </div>
        <div id="instructions_div" class="sg-25">
          <p>
            The purpose of this web app is twofold: 
              <ul>
                <li>To allows you to run a Bayesian version of a paired t-test from the comfort of your own browser.</li>
                <li>To allow you to contrast the Bayes Factor view </li>
              </ul>
 
          </p>
          <!--<p>
            The MCMC method used is an adaptive Metropolis-within-Gibbs sampler described by <a href="http://dx.doi.org/10.1198/jcgs.2009.06134 ">Roberts and Rosenthal (2009)</a>. Everything is implemented in javascript and runs in the browser. If the output looks strange try to increase the number of burn-in steps and the number of sample steps.
        </p>-->
        </div>
      </div>
      <div class="sg-35 sgParent">
        <div id="parameters_1_div" class="sg-8">
          <div class="item_title">Prior prob. of no difference: <span id="null_prior_label">0.5</span> </div>
          <input type="range" id="null_prior_input" min="0.0" max="1.0" step="0.01" defaultValue="0.5" oninput="update_null_prior_label()" style="width: 90%">
          <script type="text/javascript">
          function update_null_prior_label() {
            var null_prob = parseFloat(document.getElementById('null_prior_input').value);
            document.getElementById('null_prior_label').innerHTML = null_prob;
            var rscale = parseFloat(document.getElementById('prior_scale_input').value);
            var prior_sample = sample_from_prior(10000, null_prob, rscale);
            var xlim = eff_size_xlim;
            prior_sample = prior_sample.filter(function(s) { return s >= xlim[0] && s <= xlim[1]; });
            var lower_rope = parseFloat(document.getElementById('lower_rope_input').value);
            var upper_rope = parseFloat(document.getElementById('upper_rope_input').value);
            plot_mcmc_hist("prior_eff_size_plot", prior_sample, false, null, false, [lower_rope, upper_rope], xlim, 0.2);
          }
          </script>
          <div class="item_title">Scale of effect size prior</div>
          <select id="prior_scale_input" oninput="update_null_prior_label()">
            <option value="0.7071068">Medium: sqrt(2)/2 = .707</option>
            <option value="1.0">Wide: 1.0</option>
            <option value="1.414214">Ultrawide: sqrt(2) = 1.41</option>
          </select>
          <div class="item_title">Nbr of burn-in samples</div>
          <input id="nbr_of_burnin_input" type="text" name="nbr_of_burnin" style="width: 90%;" value="10000" />
          <div class="item_title">Nbr of samples</div>
          <input id="nbr_of_samples_input" type="text" name="nbr_of_samples" value="20000" style="width: 90%;" />
          <br/>
          <br/>
          <button id="start_button" type="button" onclick="run_model()" style="width: 100%; height: 60px">Click to start!</button>
        </div>
        <div id="parameters_2_div" class="sg-8 borderRight">
          <div class="item_title">Lower ROPE: <span id="lower_rope_label">-0.2</span> </div>
          <input type="range" id="lower_rope_input" min="-3" max="3.0" step="0.1" value="-0.2" oninput="update_rope_label()" style="width: 90%" />
          <div class="item_title">Upper ROPE: <span id="upper_rope_label">0.2</span> </div>
          <input type="range" id="upper_rope_input" min="-3" max="3.0" step="0.1" value="0.2" oninput="update_rope_label()" style="width: 90%" />
          <script type="text/javascript">
          function update_rope_label() {
            var raw_lower_rope = parseFloat(document.getElementById('lower_rope_input').value);
            var raw_upper_rope = parseFloat(document.getElementById('upper_rope_input').value);
            var lower_rope = Math.min(raw_lower_rope, raw_upper_rope);
            var upper_rope = Math.max(raw_lower_rope, raw_upper_rope);
            document.getElementById('lower_rope_input').value = lower_rope;
            document.getElementById('upper_rope_input').value = upper_rope;
            document.getElementById('lower_rope_label').innerHTML = lower_rope;
            document.getElementById('upper_rope_label').innerHTML = upper_rope;
            update_null_prior_label();
          }
          </script>
          <div class="item_title">Prior - Effect size</div>
          <div id="prior_eff_size_plot" style="height: 200px;width:100%;"></div>
          <div class="item_description">The prior on the effect size defined as (µ₁ - µ₂) / σ </div>
        </div>
        <div id="log_wrapper_div" class="sg-16">
          <center><h3>Some things to try out</h3></center>
        
        <p>...</p>
        



        <!--
          <div class="item_title">Log</div>
          <textarea id="log" style="width: 100%; height: 220px; box-sizing: border-box; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; "></textarea>
        -->
        </div>
      </div>
      <div id="animated_plots_div">
        <div id="eff_size_traceplot_wrapper_div" class="sg-8">
          <div class="item_title">Traceplot - Effect size</div>
          <div id="eff_size_traceplot" style="height: 200px;"></div>
          <div class="item_description">A traceplot as a sanity check that the MCMC estimation did not go wrong.</div>
        </div>
        <div id="eff_size_hist_wrapper_div" class="sg-8">
          <div class="item_title">Posterior - Effect size</div>
          <div id="eff_size_hist" style="height: 200px;"></div>
          <div class="item_description">The posterior probability of the effect size after having used the data.</div>
        </div>
        <div id="regions_prob_barplot_wrapper_div" class="sg-8">
          <div class="item_title">Post. Prob. of Interest regions</div>
          <div id="regions_barplot" style="height: 200px;"></div>
          <div class="item_description">The amount of probability that is lower than, inside and higher than the ROPE.</div>
        </div>
        <div id="model_prob_barplot_wrapper_div" class="sg-8">
          <div class="item_title">Posterior Prob of H0/H1</div>
          <div id="model_prob_barplot" style="height: 200px;"></div>
          <div class="item_description">If the prob. of no difference is set to 0.5 this gives a BF of <span id="bf_span">...</span> in favor of H1.</div>
        </div>
      </div>
    <div id="more_results_wrapper_div">
      <div id="more_results_parent_div" class="sg-35 sgParent">
        <div id="more_results_div" class="sg-35 borderLeft">
          <h2>More Results - The Rest of the Parameters!</h2>
          <p>Even though the difference between the means of the groups usually is the main interest, BEST also estimates other parameters. Except for the means and SDs of the groups BEST estimates a measure of to what degree there are outliers in the data that makes the distribution of the data deviate from normality. This measure is labeled "Normality" below where a normality estimate &lt; 1.5 indicates that the data isn't normally distributed. BEST is however robust to outliers to some degree while outliers are a problem for a classical t-test. More about the assumptions of BEST and the advantages of Bayesian estimation is found in <a href="http://www.indiana.edu/~kruschke/BEST/">Kruschke (2012)</a>.</p>
        </div>
      </div>
      <div id="group1_mean_plot_wrapper_div" class="sg-8">
        <div class="item_title">Trace plot - Mean Group 1</div>
        <div id="group1_mean_plot" style="height: 175px;"></div>
      </div>
      <div id="group1_mean_hist_wrapper_div" class="sg-8 borderRight">
        <div class="item_title">Posterior - Mean Group 1</div>
        <div id="group1_mean_hist" style="height: 175px;"></div>
      </div>
      <div id="mean_diff_plot_wrapper_div" class="sg-8">
        <div class="item_title">Trace plot - Difference in means</div>
        <div id="mean_diff_plot" style="height: 175px;"></div>
      </div>
      <div id="mean_diff_hist_wrapper_div" class="sg-8">
        <div class="item_title">Posterior - Difference in means</div>
        <div id="mean_diff_hist" style="height: 175px;"></div>
      </div>
      <div id="group2_mean_plot_wrapper_div" class="sg-8">
        <div class="item_title">Trace plot - Mean Group 2</div>
        <div id="group2_mean_plot" style="height: 175px;"></div>
      </div>
      <div id="group2_mean_hist_wrapper_div" class="sg-8 borderRight">
        <div class="item_title">Posterior - Mean Group 2</div>
        <div id="group2_mean_hist" style="height: 175px;"></div>
      </div>
      <div id="sd_plot_wrapper_div" class="sg-8">
        <div class="item_title">Trace plot - Standard deviation</div>
        <div id="sd_plot" style="height: 175px;"></div>
      </div>
      <div id="sd_hist_wrapper_div" class="sg-8">
        <div class="item_title">Posterior - Standard deviation</div>
        <div id="sd_hist" style="height: 175px;"></div>
      </div>
    </div>

    <div id="about_div" class="sg-35 borderRight">
        <p>
      <br>&nbsp;
      <br>&nbsp;
    </p>
      <b>About.</b> This web app was created by me,  <a href="http://www.sumsar.net">Rasmus Bååth</a>. Libraries used: <a href="http://www.jstat.org/">jStat</a> for some statistical functions, <a href="http://www.flotcharts.org/">Flot</a> for plotting and <a href="http://jquery.com/">JQuery</a> for this and that. For css styling I used <a href="http://thesquaregrid.com/">the Square Grid framework</a>. For MCMC I used my homegrown <a href="https://github.com/rasmusab/bayes.js">bayes.js</a> framework. If you have any suggestions for improvements feel free to <a href="mailto:rasmus.baath@gmail.com">drop me a message</a>. <b>A word of caution.</b> This web app should be considered a demo and if you want to include a Bayesian version of a t-test in a publication I recommend you use, for example, <a href="http://www.indiana.edu/~kruschke/BEST/">BEST</a> or the <a href="https://github.com/richarddmorey/BayesFactor">BayesFactor package</a>.  
    </div>
    <div class="sg-35 page_bottom ">
      <br />
      <span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/InteractiveResource" property="dct:title" rel="dct:type">Coded by <a xmlns:cc="http://creativecommons.org/ns#" href="http://sumsar.net/" property="cc:attributionName" rel="cc:attributionURL">Rasmus Bååth</a> 2017.<br/> Licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US">Creative Commons Attribution-ShareAlike 3.0 Unported License</a>.</span> 
      </div>
      
    
</div><!-- end #container -->
</div><!-- end #wrapper -->

<script type="text/javascript">

</script>
    
</body>
</html>
